name: Apply Full Redesign (create branch & PR with prototype + Next/Tailwind)

on:
  workflow_dispatch:

jobs:
  create-full-redesign-pr:
    name: Create full redesign branch and PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Configure git and create branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          BRANCH=vercel/full-redesign
          git checkout -b "$BRANCH"

      - name: Ensure package.json exists
        run: |
          if [ ! -f package.json ]; then
            echo '{}' > package.json
            git add package.json
            git commit -m "chore: add placeholder package.json" || true
          fi

      - name: Install required packages (Next + Tailwind + deps)
        run: |
          npm install next react react-dom
          npm install -D tailwindcss postcss autoprefixer

      - name: Initialize Tailwind if not present
        run: |
          npx tailwindcss init -p || true

      - name: Write Next/Tailwind pages & components
        run: |
          mkdir -p pages components styles public/homehni public/homehni/assets tools

          cat > pages/_app.tsx <<'EOF'
import '../styles/globals.css';
import type { AppProps } from 'next/app';

export default function App({ Component, pageProps }: AppProps) {
  return <Component {...pageProps} />;
}
EOF

          cat > pages/index.tsx <<'EOF'
import Head from 'next/head';
import Header from '../components/Header';
import Footer from '../components/Footer';
import PropertyCard from '../components/PropertyCard';

const sampleProps = [
  { id: '1', title: 'Modern Apartment in Dubai', price: 'AED 1,200,000', image: '/images/sample-house-1.jpg' },
  { id: '2', title: 'Family Villa in Abu Dhabi', price: 'AED 3,400,000', image: '/images/sample-house-2.jpg' },
  { id: '3', title: 'Cozy Studio in Sharjah', price: 'AED 450,000', image: '/images/sample-house-3.jpg' },
];

export default function Home() {
  return (
    <>
      <Head>
        <title>homehni — Find properties in the UAE</title>
        <meta name="description" content="Find properties and real estate listings in UAE." />
      </Head>

      <Header />

      <main className="min-h-[70vh] bg-white">
        <section className="max-w-6xl mx-auto px-6 py-16 lg:flex lg:items-center lg:gap-12">
          <div className="lg:flex-1">
            <h1 className="text-4xl sm:text-5xl font-extrabold text-[#222222] leading-tight">
              Find your next home in the UAE
            </h1>
            <p className="mt-4 text-lg text-[#666666] max-w-2xl">
              Browse verified properties, compare prices, and connect with reliable agents — all in one place.
            </p>
            <div className="mt-8 flex flex-wrap gap-3">
              <a href="/properties" className="inline-flex items-center px-5 py-3 bg-[#1E90FF] text-white rounded-lg font-medium shadow hover:bg-blue-700">
                Browse Properties
              </a>
              <a href="/about" className="inline-flex items-center px-5 py-3 border border-slate-200 rounded-lg text-[#222222] hover:bg-slate-50">
                Learn more
              </a>
            </div>
          </div>

          <div className="mt-10 lg:mt-0 lg:flex-1">
            <div className="w-full rounded-xl overflow-hidden shadow-xl">
              <img src="/images/hero-illustration.jpg" alt="Properties illustration" className="w-full h-72 object-cover" />
            </div>
          </div>
        </section>

        <section className="bg-[#f8fafc] py-12">
          <div className="max-w-6xl mx-auto px-6">
            <h2 className="text-2xl font-semibold text-[#222222]">Latest Properties</h2>
            <div className="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
              {sampleProps.map(p => <PropertyCard key={p.id} title={p.title} price={p.price} image={p.image} />)}
            </div>
          </div>
        </section>
      </main>

      <Footer />
    </>
  );
}
EOF

          cat > components/Header.tsx <<'EOF'
import Link from 'next/link';

export default function Header() {
  return (
    <header className="border-b bg-white">
      <div className="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
        <Link href="/"><a className="text-xl font-bold text-[#1E90FF]">homehni</a></Link>

        <nav className="hidden md:flex items-center gap-6">
          <Link href="/properties"><a className="text-[#666666] hover:text-[#222222]">Properties</a></Link>
          <Link href="/about"><a className="text-[#666666] hover:text-[#222222]">About</a></Link>
          <Link href="/contact"><a className="text-[#666666] hover:text-[#222222]">Contact</a></Link>
          <Link href="/signin"><a className="ml-2 inline-flex items-center px-3 py-2 bg-[#1E90FF] text-white rounded-md">Sign in</a></Link>
        </nav>

        <div className="md:hidden">
          <button aria-label="Open menu" className="p-2 text-[#666666]">☰</button>
        </div>
      </div>
    </header>
  )
}
EOF

          cat > components/Footer.tsx <<'EOF'
export default function Footer() {
  return (
    <footer className="border-t bg-white">
      <div className="max-w-6xl mx-auto px-6 py-6 flex flex-col sm:flex-row items-center justify-between">
        <p className="text-[#666666] text-sm">© {new Date().getFullYear()} homehni. All rights reserved.</p>
        <div className="mt-3 sm:mt-0 flex gap-4">
          <a href="/privacy" className="text-[#666666] text-sm">Privacy</a>
          <a href="/terms" className="text-[#666666] text-sm">Terms</a>
        </div>
      </div>
    </footer>
  )
}
EOF

          cat > components/PropertyCard.tsx <<'EOF'
type Props = { title: string; price: string; image: string };

export default function PropertyCard({ title, price, image }: Props) {
  return (
    <article className="bg-white rounded-xl shadow p-4">
      <img src={image} alt={title} className="w-full h-44 object-cover rounded-md" />
      <div className="mt-3">
        <h3 className="font-semibold text-[#222222]">{title}</h3>
        <p className="text-[#1E90FF] font-semibold mt-1">{price}</p>
      </div>
    </article>
  );
}
EOF

          cat > styles/globals.css <<'EOF'
@tailwind base;
@tailwind components;
@tailwind utilities;

/* Brand tokens */
:root{
  --color-primary: #1E90FF;
  --color-accent: #FF7A59;
  --color-background: #FFFFFF;
  --color-text: #222222;
}

html, body, #__next { height: 100%; }
body { background: var(--color-background); color: var(--color-text); font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
EOF

          cat > tailwind.config.js <<'EOF'
module.exports = {
  content: [
    './pages/**/*.{js,ts,jsx,tsx}',
    './components/**/*.{js,ts,jsx,tsx}',
    './public/homehni/**/*.{html,css}'
  ],
  theme: {
    extend: {},
  },
  plugins: [],
};
EOF

          cat > postcss.config.js <<'EOF'
module.exports = {
  plugins: {
    tailwindcss: {},
    autoprefixer: {},
  },
};
EOF

      - name: Write static prototype (public/homehni)
        run: |
          cat > public/homehni/index.html <<'EOF'
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>HomeHNI Prototype</title>
  <link rel="stylesheet" href="./styles.css">
</head>
<body>
  <header class="hh-header">
    <div class="container">
      <div class="logo">homehni</div>
      <nav>
        <a href="#">Properties</a>
        <a href="#">Agents</a>
        <a href="#">Contact</a>
      </nav>
    </div>
  </header>

  <main class="hh-hero">
    <div class="container">
      <h1>Find your next home in the UAE</h1>
      <p>Search verified properties with ease — prototype based on Bayut layout.</p>
      <div class="search">[Search box placeholder]</div>
    </div>
  </main>

  <section class="featured">
    <div class="container">
      <h2>Featured Listings</h2>
      <div class="cards">
        <div class="card">Property 1</div>
        <div class="card">Property 2</div>
        <div class="card">Property 3</div>
      </div>
    </div>
  </section>

  <footer class="hh-footer">
    <div class="container">© HomeHNI Prototype</div>
  </footer>
</body>
</html>
EOF

      - name: Add visual comparison tools
        run: |
          cat > tools/compare-homepages.js <<'EOF'
/*
  tools/compare-homepages.js
  - Launches local server and captures screenshots of local prototype and Bayut (if reachable).
  - Uses Puppeteer + pixelmatch. Run from tools/ with `npm run compare`.
*/
const puppeteer = require('puppeteer');
const fs = require('fs');
const pixelmatch = require('pixelmatch');
const { PNG } = require('pngjs');

(async () => {
  const out = './tools/output';
  fs.mkdirSync(out, { recursive: true });
  const browser = await puppeteer.launch({ args: ['--no-sandbox','--disable-setuid-sandbox'] });
  const page = await browser.newPage();

  // Capture local prototype
  await page.goto('http://localhost:3000/homehni/', { waitUntil: 'networkidle2' });
  await page.screenshot({ path: out + '/homehni.png', fullPage: true });

  // Try to capture Bayut (may fail in CI)
  try {
    await page.goto('https://www.bayut.com', { waitUntil: 'networkidle2', timeout: 20000 });
    await page.screenshot({ path: out + '/bayut.png', fullPage: true });

    // Create diff if both exist
    const img1 = PNG.sync.read(fs.readFileSync(out + '/homehni.png'));
    const img2 = PNG.sync.read(fs.readFileSync(out + '/bayut.png'));
    const { width, height } = img1;
    const diff = new PNG({ width, height });
    const num = pixelmatch(img1.data, img2.data, diff.data, width, height, { threshold: 0.1 });
    fs.writeFileSync(out + '/diff.png', PNG.sync.write(diff));
    console.log('Diff saved to', out + '/diff.png', 'pixels different:', num);
  } catch (e) {
    console.log('Skipping external capture (network issue):', e.message);
  }

  await browser.close();
})();
EOF

      - name: Commit changes
        run: |
          git add -A
          git commit -m "feat(redesign): add static prototype and Next/Tailwind homepage + components and deps" || echo "no changes to commit"

      - name: Push branch
        run: |
          BRANCH=vercel/full-redesign
          git push --set-upstream origin "$BRANCH"

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat(redesign): add static prototype + Next/Tailwind homepage and deps"
          branch: vercel/full-redesign
          title: "Full Redesign: Prototype import + Next/Tailwind homepage (automated)"
          body: |
            This PR imports the static HomeHNI prototype and adds a Next.js + Tailwind-based homepage and core components.

            What this PR adds:
            - public/homehni/ static prototype (index.html + styles.css + assets)
            - tools/visual comparison utilities (tools/compare-homepages.js)
            - Next.js pages/components: pages/index.tsx, pages/_app.tsx, components/Header/Footer/PropertyCard
            - Tailwind config + PostCSS + globals
            - Installs dependencies: next, react, react-dom; devDependencies: tailwindcss, postcss, autoprefixer
            - package-lock.json updated

            Next steps (post-merge):
            1) Wire homepage/listings/detail pages to /api/properties and fetch live data (I will add follow-up commits).
            2) Replace placeholder images in public and pages with optimized photos.
            3) Accessibility and responsive polish, lazy-loading and performance tuning.

            How to test locally:
            - git fetch origin && git checkout vercel/full-redesign
            - npm ci
            - npm run dev
          labels: 'redesign, automated'
